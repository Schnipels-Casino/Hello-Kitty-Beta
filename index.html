<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Emoji Match 3 — Coming Soon | JK Games</title>
  <meta name="description" content="Vorschau-Seite zu Emoji Match 3 (E.M.3) mit Regeln & AGB-Gate, Mini‑Game, Tic‑Tac‑Toe vs Bot, Live Top‑5 und animiertem Hintergrund.">
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#1a0b2e;
      --fg:#ffffff;
      --muted:#c9c5d8;
      --accent:#7c5cff;
      --accent2:#00d1ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --tttCellMin: 74px; /* base cell size */
      --tttGridMax: 360px; /* base grid width */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      background: radial-gradient(1200px 800px at 10% 10%, #1a1140 0%, transparent 60%),
                  radial-gradient(1000px 600px at 90% 20%, #0b3a59 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background-attachment: fixed;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(16px, 3vw, 32px);
    }

    .card{
      width:min(980px, 100%);
      background: rgba(17,10,31,0.65);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(18px, 2.4vw, 28px);
      position:relative;
      overflow:hidden;
      z-index: 0;
    }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: conic-gradient(from 180deg, var(--accent), var(--accent2), var(--accent), transparent 65%);
      filter: blur(30px); opacity:.25; z-index:-1; pointer-events:none;
    }

    .fx{
      position:absolute; inset:0;
      transform: translateY(28px);
      z-index: 0; pointer-events:none;
    }

    header, .hero, .grid, .game-wrap, .ttt-wrap, .cta, footer { position:relative; z-index: 2; }

    header{
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center; font-weight:800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 8px 24px rgba(124,92,255,.45);
    }
    .title{ line-height:1.05; }
    .title .full{ font-size: clamp(22px, 2.6vw, 32px); font-weight:800; letter-spacing: .3px; }
    .title .short{ display:none; font-size: clamp(22px, 2.6vw, 32px); font-weight:800; letter-spacing: .8px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(124,92,255,.16); color:#eae5ff; border:1px solid rgba(124,92,255,.35);
    }

    .hero{ margin: clamp(14px, 2.2vw, 24px) 0 6px; }
    .coming{
      font-size: clamp(40px, 6.4vw, 74px);
      font-weight:900;
      letter-spacing:-.5px;
      margin:0 0 10px 0;
      background: linear-gradient(90deg, #fff, #cdd8ff 35%, #a8fff8 60%, #fff);
      -webkit-background-clip:text; background-clip:text; color: transparent;
      text-shadow: 0 6px 30px rgba(0,0,0,.25);
      animation: shine 5s linear infinite;
    }
    @keyframes shine{
      50%{ filter: drop-shadow(0 0 12px rgba(160,220,255,.35)); }
    }
    .subtitle{ color:var(--muted); margin:0 0 18px; font-size: clamp(14px, 1.6vw, 16px); }

    .grid{
      display:grid; grid-template-columns: repeat( auto-fit, minmax(220px, 1fr) ); gap:12px;
    }
    .feat{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px; padding:14px; display:flex; gap:12px; align-items:flex-start;
      backdrop-filter: blur(2px);
    }
    .feat i{ font-style:normal; font-size:20px; }
    .feat h3{ margin:0 0 6px; font-size:16px }
    .feat p{ margin:0; color:var(--muted); font-size:14px; }

    .cta{
      margin-top:18px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .btn{
      appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#091317;
      box-shadow: 0 8px 22px rgba(0,150,200,.25);
      text-decoration:none; display:inline-block;
      touch-action: manipulation;
    }
    .btn.secondary{ background: transparent; color:#e9e6ff; border:1px solid rgba(255,255,255,0.18); box-shadow:none }
    .btn.locked{ opacity:.6; cursor:not-allowed; position:relative; }
    .btn.locked::after{ content:'🔒'; margin-left:8px; }
    .btn.disabled{ opacity:.5; cursor:not-allowed; }

    .mutelink{ color:#b9b6c9; text-decoration:underline dotted; text-underline-offset:3px; }

    footer{ margin-top:18px; color:#a7a2ba; font-size:12px; }

    /* Consent Gate */
    .gate{
      position:fixed; inset:0; display:grid; place-items:center; background: rgba(7,10,20,0.75);
      backdrop-filter: blur(8px); padding:18px; z-index:100;
    }
    .gate-card{
      width:min(920px, 100%);
      background: rgba(17,10,31,0.9);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:16px; box-shadow: var(--shadow);
      padding: clamp(16px, 2.2vw, 22px);
      max-height: 86vh; overflow:auto;
    }
    .gate h2{ margin:0 0 10px; font-size: clamp(18px, 2.4vw, 24px); }
    .gate h3{ margin:18px 0 8px; font-size: 16px; }
    .list{ margin:0; padding-left:20px; color:#d8d4e6; }
    .list li{ margin:6px 0; }

    .checks{ display:grid; gap:10px; margin-top:14px; }
    .confirm{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between; margin-top:12px; }
    .confirm .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .accept{ opacity:.5; pointer-events:none; }
    .reset-link{ font-size:12px; }

    /* Mobile title swap */
    @media (max-width: 420px){
      .title .full{ display:none }
      .title .short{ display:block }
    }

    /* --- Langeweile-Spiel styles --- */
    .game-wrap{
      margin-top:20px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; padding:14px;
    }
    .game-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .game-info{ color:var(--muted); font-size:14px; }
    .scoreboard{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .score{ font-weight:800; }
    .phase{ font-size:12px; opacity:.85; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.15); }
    canvas{ width:100%; height:auto; display:block; background:#0b1b2a; border-radius:10px; border:1px solid rgba(255,255,255,0.08); }
    .controls{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .jump-btn{ padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); color:#fff; font-weight:700; }

    .top5{ margin-top:12px; }
    .top5 h4{ margin:0 0 8px; }
    .top5 ul{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .top5 li{ display:flex; justify-content:space-between; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:8px 10px; }

    /* --- TicTacToe styles (mobile-first smaller) --- */
    .ttt-wrap{
      margin-top:18px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius:14px; padding:12px;
    }
    .ttt-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
      color:var(--muted); font-size:14px;
    }
    .ttt-controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .ttt-controls select{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.18); color:#fff; }
    .ttt-status{ margin:6px 0 10px; color:#e7e4f5; font-weight:600; font-size:14px; }

    .ttt-grid{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:6px;
      max-width: min(100%, var(--tttGridMax));
      margin: 0 auto;
    }
    .ttt-cell{
      aspect-ratio: 1 / 1;
      min-height: var(--tttCellMin);
      display:grid; place-items:center;
      font-weight:900; font-size: clamp(22px, 8.5vw, 36px);
      color:#fff;
      border-radius:10px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .ttt-cell:hover{ background: rgba(255,255,255,0.1); }
    .ttt-cell.disabled{ cursor:not-allowed; opacity:.7; }
    .ttt-cell.win{ box-shadow: 0 0 0 2px rgba(0,255,150,.5) inset, 0 0 22px rgba(0,255,150,.24); }
    .ttt-stats{ margin-top:8px; color:var(--muted); font-size:13px; }

    /* Compact tweaks for small screens */
    @media (max-width: 480px){
      :root{
        --tttCellMin: 52px;
        --tttGridMax: 280px;
      }
      .ttt-wrap{ padding:10px; }
      .ttt-status{ font-size:13px; }
      .ttt-header{ font-size:13px; }
      .btn{ padding:10px 14px; }
    }

    /* --- Redirect Modal --- */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(6,9,16,.65);
      backdrop-filter: blur(6px); z-index:110;
      padding:16px;
    }
    .modal.show{ display:grid; }
    .modal-card{
      width:min(820px,100%); background:rgba(17,10,31,.95);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; box-shadow: var(--shadow);
      padding:18px;
    }
    .modal h3{ margin:0 0 8px; font-size: clamp(18px, 2.2vw, 22px); }
    .modal p{ margin:8px 0; color:var(--muted); }
    .modal ul{ margin:8px 0 0; padding-left:20px; color:#d8d4e6; }
    .modal li{ margin:6px 0; }
    .modal .actions{ margin-top:14px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .modal .ack{ margin-top:10px; }
    .modal .go{ opacity:.5; pointer-events:none; }
  </style>
</head>
<body>
  <noscript>
    <div style="padding:16px; background:#ffecb3; color:#402; text-align:center; font-weight:600;">Bitte aktiviere JavaScript, um diese Seite zu nutzen.</div>
  </noscript>

  <!-- Consent Gate (hidden after accept) -->
  <div class="gate" id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h2>Regeln & AGBs bestätigen</h2>
      <p class="subtitle">Dies ist eine Vorschau/Beta-Seite. Bitte lies die folgenden Punkte aufmerksam durch.</p>

      <h3>Spiel-Regeln (Fair Play)</h3>
      <ol class="list">
        <li>Kein Cheating: keine Hacks, keine Mods, keine Scripts, keine Bots.</li>
        <li>Keine Manipulation am Spiel/Code/Netzwerk (inkl. DevTools, Tamper-/Userscripts, Memory-/Traffic-Editoren).</li>
        <li>Keine externen Geräte/Automationen (Makros, Auto-Clicker, Macro-Controller, etc.).</li>
        <li>Kein Reverse Engineering, Kopieren, Re-Hosting oder Weitergabe der Datei.</li>
        <li>Kein Ausnutzen von Bugs/Glitches. Bitte melde Fehler stattdessen.</li>
        <li>Respektvoller Umgang. Verstöße können zum Ausschluss führen.</li>
      </ol>

      <h3>AGB (Kurzfassung – unverbindliches Beispiel)</h3>
      <ul class="list">
        <li><b>Beta/Preview:</b> Die Anwendung befindet sich in Entwicklung; Funktionen können sich ändern oder ausfallen.</li>
        <li><b>Sicherheit:</b> Nutze <u>kein</u> Passwort, das du irgendwo sonst verwendest. Verwende einen Fantasienamen.</li>
        <li><b>Speicherung:</b> Technisch notwendige Daten (z. B. Einwilligung) können lokal (LocalStorage) gespeichert werden.</li>
        <li><b>Werbung:</b> Derzeit keine Werbung; zukünftige Einbindung ist möglich.</li>
        <li><b>Kein Rebranding:</b> Die Datei darf nicht als eigene ausgegeben, verkauft oder weiterverbreitet werden.</li>
        <li><b>Haftung:</b> Keine Gewähr für Verfügbarkeit, Richtigkeit, Datenverlust oder Schäden.</li>
        <li><b>Änderungen:</b> Regeln/AGB können aktualisiert werden. Prüfe sie bei Änderungen erneut.</li>
      </ul>

      <div class="checks">
        <label><input type="checkbox" id="cRules"> Ich habe die <b>Regeln</b> gelesen und akzeptiere sie.</label>
        <label><input type="checkbox" id="cTerms"> Ich habe die <b>AGBs</b> gelesen und akzeptiere sie.</label>
      </div>

      <div class="confirm">
        <div class="left">
          <button class="btn accept" id="acceptBtn">Bestätigen & fortfahren</button>
          <button class="btn secondary" id="declineBtn" aria-label="Ablehnen">Ablehnen</button>
        </div>
        <a class="mutelink reset-link" href="#" id="explainReset">Zustimmung später zurücksetzen</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <main class="card" aria-live="polite">
      <!-- FX canvas goes first so it's behind content -->
      <canvas id="fx" class="fx" width="1024" height="512" aria-hidden="true"></canvas>

      <header>
        <div class="brand">
          <div class="logo">🎮</div>
          <div class="title">
            <div class="full">Emoji Match 3</div>
            <div class="short">E.M.3</div>
          </div>
          <span class="badge" title="Info">Großes Update in Arbeit</span>
        </div>
        <a class="mutelink" href="#" id="resetConsent">AGB & Regeln zurücksetzen</a>
      </header>

      <section class="hero">
        <h1 class="coming" aria-label="Coming Soon">Coming&nbsp;Soon</h1>
        <p class="subtitle">Vorschau von JK Games. Bleib dran – das nächste große Update landet bald.</p>
      </section>

      <section class="grid" aria-label="Highlights">
        <article class="feat">
          <i>👤</i>
          <div>
            <h3>Konto-System</h3>
            <p>Erstelle ein Konto (Fantasiename empfohlen) und verwalte dein Profil.</p>
          </div>
        </article>
        <article class="feat">
          <i>💰</i>
          <div>
            <h3>Geld verdienen</h3>
            <p>Spiele, meistere Challenges und sammle In‑Game‑Währung.</p>
          </div>
        </article>
        <article class="feat">
          <i>🏆</i>
          <div>
            <h3>Bestenliste</h3>
            <p>Vergleiche deine Bestleistung live mit anderen.</p>
          </div>
        </article>
        <article class="feat">
          <i>🎨</i>
          <div>
            <h3>Volle Design‑Kontrolle</h3>
            <p>Passe Farben, Hintergründe und Effekte komplett nach deinem Style an.</p>
          </div>
        </article>
        <article class="feat">
          <i>⚙️</i>
          <div>
            <h3>Viele Möglichkeiten</h3>
            <p>Power‑Ups, Spielmodi, Daily‑Ziele und mehr – alles im Aufbau.</p>
          </div>
        </article>
        <article class="feat">
          <i>🔒</i>
          <div>
            <h3>Hinweis zur Sicherheit</h3>
            <p>Nutze ein einzigartiges Passwort nur für dieses Spiel (keine sensiblen Daten).</p>
          </div>
        </article>
      </section>

      <!-- Langeweile-Spiel section -->
      <section class="game-wrap" aria-label="Langeweile-Spiel">
        <div class="game-header">
          <div class="game-info">
            <strong>Langeweile‑Spiel</strong> • Springen: <kbd>Leertaste</kbd>/<kbd>▲</kbd> • Mobile: Button
          </div>
          <div class="scoreboard">
            <span class="phase" id="phaseTag">Oberwelt</span>
            <span class="score">Score: <span id="score">0</span></span>
            <button class="btn" id="startBtn" type="button">Starten</button>
            <button class="btn secondary" id="restartBtn" type="button" style="display:none">Nochmal</button>
          </div>
        </div>
        <canvas id="game" width="800" height="220" aria-label="Runner Spiel"></canvas>
        <div class="controls">
          <button class="jump-btn" id="jumpBtn" type="button">Springen</button>
        </div>

        <div class="top5">
          <h4>Top&nbsp;5 (Live)</h4>
          <ul id="top5List">
            <li><em>Noch keine Einträge…</em><span></span></li>
          </ul>
        </div>
      </section>

      <!-- Spaßgame: Tic Tac Toe -->
      <section class="ttt-wrap" aria-label="Spaßgame – Tic‑Tac‑Toe">
        <div class="ttt-header">
          <div><strong>Spaßgame:</strong> Tic‑Tac‑Toe vs. Bot</div>
          <div class="ttt-controls">
            <label>Ich spiele:&nbsp;
              <select id="tttSymbol" aria-label="Symbol wählen">
                <option value="X">✖️ Kreuz (X)</option>
                <option value="O">⚪ Kreis (O)</option>
              </select>
            </label>
            <button class="btn" id="tttNew" type="button">Neues Spiel</button>
          </div>
        </div>
        <div class="ttt-status" id="tttStatus">Du bist X. X beginnt.</div>
        <div class="ttt-grid" id="tttGrid" role="grid" aria-label="Tic‑Tac‑Toe Brett">
          <div class="ttt-cell" role="gridcell" data-idx="0" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="1" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="2" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="3" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="4" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="5" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="6" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="7" tabindex="0"></div>
          <div class="ttt-cell" role="gridcell" data-idx="8" tabindex="0"></div>
        </div>
        <div class="ttt-stats">Siege: <span id="tttWin">0</span> • Niederlagen: <span id="tttLose">0</span> • Unentschieden: <span id="tttDraw">0</span></div>
      </section>

      <div class="cta">
        <a class="btn locked" id="newSiteBtn" href="https://j-k-games.github.io/Emoji-Match-1/" aria-disabled="true" title="Der Zugang ist vorübergehend gesperrt. Bitte Hinweis lesen.">Zur neuen Webseite</a>
      </div>

      <footer>
        <p>© <span id="year"></span> JK Games • Vorschau-Build • Dies ist keine rechtsverbindliche Beratung. Inhalte können sich ändern.</p>
      </footer>
    </main>
  </div>

  <!-- Redirect Modal -->
  <div class="modal" id="redirectModal" role="dialog" aria-modal="true" aria-labelledby="redirectTitle" aria-describedby="redirectDesc">
    <div class="modal-card">
      <h3 id="redirectTitle">Wichtig – bitte durchlesen</h3>
      <p id="redirectDesc">Die neue App ist stärker optimiert als das alte Game. Lies dir die Punkte kurz durch:</p>
      <ul>
        <li><b>Optimiert:</b> Es werden <u>keine drei gleichen</u> mehr gespawnt – das Spielfeld ist <b>deutlich schwerer</b>.</li>
        <li><b>Anti‑Reset:</b> Neu laden bringt <b>keine Punkte</b> und verschafft <b>keine Vorteile</b>.</li>
        <li><b>Fairness:</b> Cheating/Tricks/Manipulation sind wirkungslos und verboten.</li>
        <li><b>Bugs?</b> Das System wird laufend verbessert. Bitte melde Fehler unter <i>Konto → Bug Report</i>.</li>
      </ul>
      <label class="ack"><input type="checkbox" id="readAck"> Ich habe die Hinweise gelesen und verstanden.</label>
      <div class="actions">
        <button class="btn secondary" id="cancelRedirect" type="button">Schließen</button>
        <a class="btn disabled" id="confirmRedirect" href="#" aria-disabled="true" title="Noch nicht freigeschaltet">Zur neuen App – Weiterleiten</a>
      </div>
      <p style="margin-top:8px; color:#b7b3c7; font-size:12px;">Hinweis: Der Zugriff ist aktuell <b>gesperrt</b>. Freischaltung folgt später.</p>
    </div>
  </div>

  <!-- Consent / UI script (non-module) -->
  <script>
    (function(){
      const KEY = 'em3_consent_v1';
      const gate = document.getElementById('gate');
      const acceptBtn = document.getElementById('acceptBtn');
      const declineBtn = document.getElementById('declineBtn');
      const cRules = document.getElementById('cRules');
      const cTerms = document.getElementById('cTerms');
      const resetConsent = document.getElementById('resetConsent');
      const explainReset = document.getElementById('explainReset');
      const year = document.getElementById('year');
      year.textContent = new Date().getFullYear();

      function checkAccepted(){
        const ok = cRules.checked && cTerms.checked;
        acceptBtn.classList.toggle('accept', !ok);
        acceptBtn.setAttribute('aria-disabled', (!ok).toString());
      }

      cRules.addEventListener('change', checkAccepted);
      cTerms.addEventListener('change', checkAccepted);
      checkAccepted();

      const has = localStorage.getItem(KEY) === '1';
      if(has){ gate.style.display = 'none'; }

      acceptBtn.addEventListener('click', () => {
        if(acceptBtn.classList.contains('accept')) return;
        localStorage.setItem(KEY, '1');
        gate.style.display = 'none';
      });

      declineBtn.addEventListener('click', () => {
        alert('Ohne Zustimmung ist die Nutzung leider nicht möglich.');
        history.length > 1 ? history.back() : window.location.href = 'about:blank';
      });

      resetConsent.addEventListener('click', (e) => {
        e.preventDefault();
        if(confirm('Zustimmung zurücksetzen? Beim nächsten Besuch werden Regeln & AGBs erneut abgefragt.')){
          localStorage.removeItem(KEY);
          alert('Zustimmung wurde zurückgesetzt.');
        }
      });

      explainReset.addEventListener('click', (e) => {
        e.preventDefault();
        alert('Hinweis: Deine Zustimmung wird lokal im Browser gespeichert (LocalStorage). Über den Link oben rechts kannst du sie jederzeit zurücksetzen.');
      });

      // --- Redirect Modal logic (hard-locked) ---
      const newSiteBtn = document.getElementById('newSiteBtn');
      const modal = document.getElementById('redirectModal');
      const cancelRedirect = document.getElementById('cancelRedirect');
      const confirmRedirect = document.getElementById('confirmRedirect');
      const readAck = document.getElementById('readAck');

      function openModal(e){ if(e){ e.preventDefault(); } modal.classList.add('show'); }
      function closeModal(){ modal.classList.remove('show'); }

      newSiteBtn.addEventListener('click', openModal);
      cancelRedirect.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

      readAck.addEventListener('change', () => {
        if(readAck.checked){ confirmRedirect.classList.remove('go'); }
        else{ confirmRedirect.classList.add('go'); }
      });

      confirmRedirect.addEventListener('click', (ev) => {
        ev.preventDefault();
        alert('Der Zugang ist aktuell gesperrt. Freischaltung folgt später.');
      });
    })();
  </script>

  <!-- FX Animation script (non-module) -->
  <script>
    (function(){
      const canvas = document.getElementById('fx');
      const ctx = canvas.getContext('2d');
      let DPR = Math.min(2, window.devicePixelRatio || 1);

      function resize(){
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * DPR);
        canvas.height = Math.floor(rect.height * DPR);
      }
      resize();
      window.addEventListener('resize', resize);

      let t = 0;
      let dayLen = 120;
      let weather = 'clear';
      let weatherTimer = 0;

      const birds = [], clouds = [], drops = [], walkers = [], flowers = [], trees = [];
      function rnd(a,b){ return Math.random()*(b-a)+a; }

      function init(){
        for(let i=0;i<8;i++) clouds.push({ x:rnd(0,1), y:rnd(0.05,0.35), s:rnd(0.08,0.18), v:rnd(0.005,0.02) });
        for(let i=0;i<12;i++) birds.push({ x:rnd(0,1), y:rnd(0.15,0.4), v:rnd(0.03,0.08) });
        for(let i=0;i<4;i++) walkers.push({ x:rnd(-0.2,1.2), y:0.86 + (i%2)*0.02, v:rnd(0.015,0.03), flip: Math.random()<0.5 });
        for(let i=0;i<6;i++) trees.push({ x:rnd(0.05,0.95), h:rnd(0.10,0.18) });
        for(let i=0;i<30;i++) flowers.push({ x:rnd(0.02,0.98), h:rnd(0.02,0.05), hue:rnd(0,360) });
      }
      init();

      let flash = 0;

      function drawScene(dt){
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0,0,W,H);
        t += dt;
        const tod = (t % dayLen) / dayLen;

        function mix(a,b,m){ return a + (b-a)*m; }
        const nightTop=[10,15,35], nightBot=[25,20,55];
        const dayTop=[120,160,230], dayBot=[180,210,255];
        const m = Math.sin(tod * Math.PI);
        const top=[Math.round(mix(nightTop[0],dayTop[0],m)),Math.round(mix(nightTop[1],dayTop[1],m)),Math.round(mix(nightTop[2],dayTop[2],m))];
        const bot=[Math.round(mix(nightBot[0],dayBot[0],m)),Math.round(mix(nightBot[1],dayBot[1],m)),Math.round(mix(nightBot[2],dayBot[2],m))];
        const g=ctx.createLinearGradient(0,0,0,H);
        g.addColorStop(0,`rgb(${top[0]},${top[1]},${top[2]})`);
        g.addColorStop(1,`rgb(${bot[0]},${bot[1]},${bot[2]})`);
        ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

        const sunAngle = tod * Math.PI * 2;
        const cx = W*0.5 + Math.cos(sunAngle) * W*0.35;
        const cy = H*0.65 - Math.sin(sunAngle) * H*0.45;
        ctx.beginPath(); ctx.arc(cx, cy, 18*DPR, 0, Math.PI*2);
        ctx.fillStyle = (Math.sin(sunAngle) > 0) ? 'rgba(255,230,150,0.95)' : 'rgba(220,220,255,0.5)'; ctx.fill();

        for(const c of clouds){ c.x += c.v * dt * (0.5 + 0.5*m); if(c.x > 1.1) c.x = -0.1; drawCloud(c.x*W, c.y*H, c.s*W, 0.5 + 0.5*m); }
        for(const b of birds){ b.x += b.v * dt * 0.7; if(b.x > 1.2) b.x = -0.2; const y=b.y*H+Math.sin((t*2 + b.x*5))*6*DPR; drawBird(b.x*W, y); }
        for(const tr of trees){ drawTree(tr.x*W, H*(0.86 - tr.h), tr.h*H); }
        for(const fl of flowers){ drawFlower(fl.x*W, H*0.92, fl.h*H, fl.hue); }
        ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.fillRect(0, H*0.92, W, H*0.02);
        for(const w of walkers){ const dir=w.flip?-1:1; w.x += w.v*dt*dir; if(w.x < -0.15){ w.flip=false; } if(w.x > 1.15){ w.flip=true; } drawWalker(w.x*W, H*0.90, w.flip); }

        weatherTimer -= dt;
        if(weatherTimer <= 0){
          const r = Math.random(); weather = (r < 0.65) ? 'clear' : (r < 0.88 ? 'rain' : 'storm');
          weatherTimer = (weather === 'clear') ? rnd(12,20) : (weather === 'rain' ? rnd(12,18) : rnd(8,14));
        }

        if(weather !== 'clear'){
          const density = (weather === 'storm') ? 140 : 80;
          while(drops.length < density){ drops.push({ x:rnd(0,W), y:rnd(-H*0.2,0), vY:rnd(H*0.6, H*1.0) }); }
          for(let i=0;i<drops.length;i++){
            const d=drops[i]; d.y += d.vY*dt; if(d.y > H){ d.y = rnd(-H*0.2, 0); d.x = rnd(0, W); }
            ctx.strokeStyle='rgba(200,220,255,0.55)'; ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x+2*DPR,d.y+8*DPR); ctx.stroke();
          }
        } else drops.length = Math.min(drops.length, 40);

        if(weather === 'storm' && Math.random() < 0.005) flash = 1;
        if(flash > 0){ ctx.fillStyle = `rgba(255,255,255,${0.6*flash})`; ctx.fillRect(0,0,W,H); flash = Math.max(0, flash - dt*2.5); }
      }

      function drawCloud(x,y,w,alpha){
        const h=w*0.45; ctx.fillStyle=`rgba(240,245,255,${0.25*alpha})`; ctx.beginPath();
        ctx.ellipse(x,y,w*0.28,h*0.5,0,0,Math.PI*2); ctx.ellipse(x-w*0.25,y+3*DPR,w*0.22,h*0.45,0,0,Math.PI*2); ctx.ellipse(x+w*0.24,y+4*DPR,w*0.26,h*0.48,0,0,Math.PI*2); ctx.fill();
      }
      function drawBird(x,y){ ctx.strokeStyle='rgba(255,255,255,0.85)'; ctx.lineWidth=1.5*DPR; ctx.beginPath(); ctx.moveTo(x-6*DPR,y); ctx.quadraticCurveTo(x-2*DPR,y-3*DPR,x,y); ctx.quadraticCurveTo(x+2*DPR,y-3*DPR,x+6*DPR,y); ctx.stroke(); }
      function drawTree(x,y,h){ ctx.fillStyle='rgba(120,80,40,0.8)'; ctx.fillRect(x-h*0.05,y+h*0.2,h*0.1,h*0.8); ctx.fillStyle='rgba(60,160,90,0.75)'; ctx.beginPath(); ctx.arc(x, y+h*0.35, h*0.35, 0, Math.PI*2); ctx.fill(); }
      function drawFlower(x,by,s,hue){ ctx.strokeStyle='rgba(120,200,120,0.8)'; ctx.beginPath(); ctx.moveTo(x,by); ctx.lineTo(x,by-s*1.2); ctx.stroke(); ctx.fillStyle=`hsla(${hue},80%,70%,0.85)`; ctx.beginPath(); ctx.arc(x,by-s*1.4,s*0.5,0,Math.PI*2); ctx.fill(); }
      function drawWalker(x,y,flip){ ctx.save(); ctx.translate(x,y); ctx.scale(flip?-1:1,1); ctx.fillStyle='rgba(220,180,120,0.95)'; ctx.fillRect(-6, -18, 12, 12); ctx.fillStyle='rgba(80,160,240,0.9)'; ctx.fillRect(-7,-6,14,10); ctx.fillStyle='rgba(160,120,240,0.9)'; ctx.fillRect(-7,4,6,10); ctx.fillRect(1,4,6,10); ctx.restore(); }

      let last=performance.now();
      function loop(now){ const dt=(now-last)/1000; last=now; drawScene(dt); requestAnimationFrame(loop); }
      requestAnimationFrame(loop);
    })();
  </script>

  <!-- Game + Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBa-8wKtWpiFVFeUrNJedjYsuIQLbI0JLQ",
      authDomain: "j-k--games.firebaseapp.com",
      projectId: "j-k--games",
      storageBucket: "j-k--games.firebasestorage.app",
      messagingSenderId: "779886305498",
      appId: "1:779886305498:web:d8e0f24b214805904285e3",
      measurementId: "G-YE25QXV7PV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const jumpBtn = document.getElementById('jumpBtn');
    const scoreEl = document.getElementById('score');
    const phaseTag = document.getElementById('phaseTag');
    const top5List = document.getElementById('top5List');

    let running = false, gameOver = false, t0 = 0, last = 0, score = 0;
    let speed = 210, gravity = 1250, groundY = canvas.height - 40;

    const player = { x: 60, y: groundY - 40, w: 28, h: 40, vy: 0, onGround: true };
    const obstacles = []; let spawnTimer = 0;
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function resetGame(){
      running = false; gameOver = false;
      score = 0; speed = 210;
      player.y = groundY - player.h; player.vy = 0; player.onGround = true;
      obstacles.length = 0; spawnTimer = 0;
      t0 = performance.now(); last = t0;
      scoreEl.textContent = '0'; phaseTag.textContent = 'Oberwelt';
      startBtn.style.display = 'inline-block'; restartBtn.style.display = 'none';
      draw(0);
    }
    function startGame(){ if(running) return; running = true; gameOver = false; t0 = performance.now(); last = t0; requestAnimationFrame(loop); }
    function endGame(){ running = false; gameOver = true; restartBtn.style.display = 'inline-block'; startBtn.style.display = 'none'; submitScore(Math.floor(score)).catch(console.warn); }
    function jump(){ if(!running || gameOver) return; if(player.onGround){ player.vy = -520; player.onGround = false; } }
    function currentPhase(elapsed){ if(elapsed <= 60) return { name:'Oberwelt', mix:0 }; const mix = clamp((elapsed-61)/10,0,1); return { name: mix>=1 ? 'Hölle' : 'Übergang', mix }; }

    function drawBackground(elapsed){
      const { mix } = currentPhase(elapsed);
      const grd = ctx.createLinearGradient(0,0,0,canvas.height);
      function lerp(a,b,t){ return Math.round(a + (b - a)*t); }
      const cTop = `rgb(${lerp(20, 20, mix)}, ${lerp(40, 8, mix)}, ${lerp(60, 8, mix)})`;
      const cMid = `rgb(${lerp(11, 58, mix)}, ${lerp(27, 10, mix)}, ${lerp(42, 10, mix)})`;
      grd.addColorStop(0, cTop); grd.addColorStop(1, cMid); ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);
      const groundColor = mix < 1 ? `rgb(${lerp(22,40,mix)}, ${lerp(90,20,mix)}, ${lerp(30,20,mix)})` : `rgb(60,20,20)`;
      ctx.fillStyle = groundColor; ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
      ctx.fillStyle = `rgba(${lerp(200,255,mix)}, ${lerp(200,60,mix)}, ${lerp(220,40,mix)}, ${0.06 + 0.12*mix})`; ctx.fillRect(0, groundY-30, canvas.width, 30);
    }

    function drawPlayer(){
      ctx.fillStyle = '#c79c68'; ctx.fillRect(player.x + 6, player.y, 16, 16);
      ctx.fillStyle = '#2aa3d8'; ctx.fillRect(player.x + 4, player.y + 16, 20, 14);
      ctx.fillStyle = '#654ea3'; ctx.fillRect(player.x + 6, player.y + 30, 7, 10); ctx.fillRect(player.x + 15, player.y + 30, 7, 10);
      ctx.fillStyle = '#000'; ctx.fillRect(player.x + 10, player.y + 5, 2, 2); ctx.fillRect(player.x + 18, player.y + 5, 2, 2);
    }

    function spawnObstacle(elapsed){
      const { mix } = currentPhase(elapsed);
      const type = (mix < 1) ? 'pig' : 'hog';
      const h = (type === 'pig') ? Math.random() * (22 - 18) + 18 : Math.random() * (32 - 26) + 26;
      const w = (type === 'pig') ? Math.random() * (36 - 28) + 28 : Math.random() * (44 - 34) + 34;
      obstacles.push({ x: canvas.width + 10, y: groundY - h, w, h, type });
    }
    function drawObstacle(o){
      if(o.type === 'pig'){ ctx.fillStyle = '#ffb8c2'; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.fillStyle = '#ff8fa3'; ctx.fillRect(o.x+o.w*0.6, o.y+o.h*0.4, o.w*0.28, o.h*0.28); }
      else { ctx.fillStyle = '#9b6a4a'; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.fillStyle = '#e5d7c8'; ctx.fillRect(o.x+2,o.y+o.h*0.2,4,4); ctx.fillRect(o.x+2,o.y+o.h*0.55,4,4); }
    }

    function loop(now){
      if(!running) return;
      const dt = (now - last) / 1000; last = now; const elapsed = (now - t0) / 1000;
      const phase = currentPhase(elapsed); phaseTag.textContent = (phase.mix < 1) ? 'Oberwelt' : 'Hölle';
      speed += dt * 3.5; score += dt * 10; scoreEl.textContent = String(Math.floor(score));
      player.vy += gravity * dt; player.y += player.vy * dt; if(player.y + player.h >= groundY){ player.y = groundY - player.h; player.vy = 0; player.onGround = true; }
      spawnTimer -= dt; if(spawnTimer <= 0){ spawnObstacle(elapsed); spawnTimer = (phase.mix < 1) ? (Math.random() * (1.6 - 0.9) + 0.9) : (Math.random() * (1.3 - 0.75) + 0.75); }
      for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x -= speed * dt; if(o.x + o.w < 0) obstacles.splice(i,1); }
      for(const o of obstacles){ if(player.x < o.x + o.w && player.x + player.w > o.x && player.y < o.y + o.h && player.y + player.h > o.y){ endGame(); } }
      drawBackground(elapsed); ctx.strokeStyle = 'rgba(255,255,255,0.07)'; ctx.beginPath(); ctx.moveTo(0, groundY + 0.5); ctx.lineTo(canvas.width, groundY + 0.5); ctx.stroke();
      drawPlayer(); obstacles.forEach(drawObstacle);
      if(running) requestAnimationFrame(loop);
    }
    function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawBackground(0); drawPlayer(); }

    function sanitizeName(name){ name = (name || '').trim(); if(!name) name = 'Gast'; return name.replace(/[<>]/g, ''); }
    async function submitScore(score){
      try{
        const nameKey = 'em3_player_name';
        let name = localStorage.getItem(nameKey) || prompt('Name für die Bestenliste (Tipp: Fantasiename)?');
        name = sanitizeName(name); localStorage.setItem(nameKey, name);
        await addDoc(collection(db, 'em3_scores'), { name, score, ts: serverTimestamp() });
      } catch(err){ console.warn('Konnte Score nicht speichern:', err?.message || err); alert('Score gespeichert (lokal). Online-Bestenliste evtl. nicht verfügbar.'); }
    }
    (function initTop5(){
      const q = query(collection(db, 'em3_scores'), orderBy('score', 'desc'), limit(5));
      onSnapshot(q, (snap) => {
        const items = []; let rank = 1;
        snap.forEach(doc => { const d = doc.data(); items.push({ rank: rank++, name: (d.name||'–'), score: d.score||0 }); });
        top5List.innerHTML = items.length === 0
          ? '<li><em>Noch keine Einträge…</em><span></span></li>'
          : items.map(it => `<li><span>#${it.rank} ${String(it.name).replace(/[<>]/g,'')}</span><span>${it.score}</span></li>`).join('');
      }, (err) => console.warn('Top5 Snapshot Fehler:', err?.message || err));
    })();

    startBtn.addEventListener('click', () => { resetGame(); startGame(); });
    restartBtn.addEventListener('click', () => { resetGame(); startGame(); });
    jumpBtn.addEventListener('click', jump);
    window.addEventListener('keydown', (e) => { if(e.code === 'Space' || e.code === 'ArrowUp'){ e.preventDefault(); jump(); } });
    draw();
  </script>

  <!-- TicTacToe logic (non-module) -->
  <script>
    (function(){
      const grid = document.getElementById('tttGrid');
      const statusEl = document.getElementById('tttStatus');
      const select = document.getElementById('tttSymbol');
      const newBtn = document.getElementById('tttNew');
      const winEl = document.getElementById('tttWin');
      const loseEl = document.getElementById('tttLose');
      const drawEl = document.getElementById('tttDraw');

      const LINES = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];

      let board = Array(9).fill(null);
      let player = 'X', bot = 'O', over = false;

      // Stats
      const STKEY = 'em3_ttt_stats';
      let stats = null;
      try{ stats = JSON.parse(localStorage.getItem(STKEY)) || {w:0,l:0,d:0}; }catch{ stats = {w:0,l:0,d:0}; }
      function renderStats(){ winEl.textContent = stats.w; loseEl.textContent = stats.l; drawEl.textContent = stats.d; }
      renderStats();
      function saveStats(){ localStorage.setItem(STKEY, JSON.stringify(stats)); }

      function setStatus(msg){ statusEl.textContent = msg; }

      function resetBoard(){
        board = Array(9).fill(null); over = false;
        [...grid.children].forEach(c => { c.textContent = ''; c.classList.remove('disabled','win'); c.setAttribute('aria-label','Leer'); });
      }

      function startGame(){
        player = select.value === 'O' ? 'O' : 'X';
        bot = player === 'X' ? 'O' : 'X';
        resetBoard();
        setStatus(`Du bist ${player}. ${player === 'X' ? 'X beginnt.' : 'Bot beginnt.'}`);
        if(player === 'O'){ botTurn(); }
      }

      function emptyIndices(){ const arr=[]; for(let i=0;i<9;i++) if(!board[i]) arr.push(i); return arr; }

      function winnerFor(sym){
        for(const [a,b,c] of LINES){
          if(board[a]===sym && board[b]===sym && board[c]===sym) return [a,b,c];
        }
        return null;
      }

      function checkEnd(){
        const pw = winnerFor(player);
        if(pw){ endGame('win', pw); return true; }
        const bw = winnerFor(bot);
        if(bw){ endGame('lose', bw); return true; }
        if(emptyIndices().length === 0){ endGame('draw'); return true; }
        return false;
      }

      function endGame(type, winLine){
        over = true;
        [...grid.children].forEach(c => c.classList.add('disabled'));
        if(type === 'win'){ stats.w++; setStatus('Du hast gewonnen! 🎉'); if(winLine) highlight(winLine); }
        else if(type === 'lose'){ stats.l++; setStatus('Der Bot hat gewonnen. 😅'); if(winLine) highlight(winLine); }
        else { stats.d++; setStatus('Unentschieden.'); }
        saveStats(); renderStats();
      }

      function highlight(line){ line.forEach(i => grid.children[i].classList.add('win')); }

      function winningMove(sym){
        for(const [a,b,c] of LINES){
          const line = [a,b,c];
          const marks = line.map(i => board[i]);
          const filled = marks.filter(Boolean).length;
          if(filled >= 2){
            let countSym = marks.filter(m => m===sym).length;
            let idxEmpty = line.find(i => !board[i]);
            if(countSym === 2 && idxEmpty !== undefined) return idxEmpty;
          }
        }
        return null;
      }

      function botTurn(){
        if(over) return;
        let move = winningMove(bot);
        if(move === null) move = winningMove(player);
        if(move === null && !board[4]) move = 4;
        const corners = [0,2,6,8].filter(i => !board[i]);
        if(move === null && corners.length) move = corners[Math.floor(Math.random()*corners.length)];
        const sides = [1,3,5,7].filter(i => !board[i]);
        if(move === null && sides.length) move = sides[Math.floor(Math.random()*sides.length)];
        if(move === null) return;
        place(move, bot);
        if(!checkEnd()) setStatus('Du bist dran.');
      }

      function place(idx, sym){
        if(board[idx] || over) return;
        board[idx] = sym;
        const cell = grid.children[idx];
        cell.textContent = sym === 'X' ? '✖' : '◯';
        cell.classList.add('disabled');
        cell.setAttribute('aria-label', sym);
      }

      function onPlayerMove(idx){
        if(over) return;
        if(board[idx]) return;
        place(idx, player);
        if(!checkEnd()){
          setStatus('Bot denkt …');
          setTimeout(botTurn, 260);
        }
      }

      grid.addEventListener('click', (e) => {
        const cell = e.target.closest('.ttt-cell');
        if(!cell) return;
        onPlayerMove(parseInt(cell.dataset.idx,10));
      });
      grid.addEventListener('keydown', (e) => {
        if((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('ttt-cell')){
          e.preventDefault();
          onPlayerMove(parseInt(e.target.dataset.idx,10));
        }
      });
      newBtn.addEventListener('click', startGame);
      select.addEventListener('change', startGame);

      startGame();
    })();
  </script>
</body>
</html>
