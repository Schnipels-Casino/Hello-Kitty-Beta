<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Emoji Match 3 — Coming Soon | JK Games</title>
  <meta name="description" content="Vorschau-Seite zu Emoji Match 3 (E.M.3) mit Regeln & AGB-Gate. Enthält ein kleines Langeweile-Spiel und eine Live Top-5 Bestenliste.">
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#1a0b2e;
      --card:#110a1f99; /* glass */
      --fg:#ffffff;
      --muted:#c9c5d8;
      --accent:#7c5cff;
      --accent2:#00d1ff;
      --danger:#ff476f;
      --good:#00e29b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--fg);
      background: radial-gradient(1200px 800px at 10% 10%, #1a1140 0%, transparent 60%),
                  radial-gradient(1000px 600px at 90% 20%, #0b3a59 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background-attachment: fixed;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(16px, 3vw, 32px);
    }

    .card{
      width:min(980px, 100%);
      background: rgba(17,10,31,0.65);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(18px, 2.4vw, 28px);
      position:relative;
      overflow:hidden;
    }

    /* decorative glow */
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: conic-gradient(from 180deg, var(--accent), var(--accent2), var(--accent), transparent 65%);
      filter: blur(30px); opacity:.25; z-index:0; pointer-events:none;
    }

    header{
      display:flex; align-items:center; gap:12px; justify-content:space-between; position:relative; z-index:1;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center; font-weight:800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 8px 24px rgba(124,92,255,.45);
    }
    .title{ line-height:1.05; }
    .title .full{ font-size: clamp(22px, 2.6vw, 32px); font-weight:800; letter-spacing: .3px; }
    .title .short{ display:none; font-size: clamp(22px, 2.6vw, 32px); font-weight:800; letter-spacing: .8px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(124,92,255,.16); color:#eae5ff; border:1px solid rgba(124,92,255,.35);
    }

    .hero{ margin: clamp(14px, 2.2vw, 24px) 0 6px; position:relative; z-index:1; }
    .coming{
      font-size: clamp(40px, 6.4vw, 74px);
      font-weight:900;
      letter-spacing:-.5px;
      margin:0 0 10px 0;
      background: linear-gradient(90deg, #fff, #cdd8ff 35%, #a8fff8 60%, #fff);
      -webkit-background-clip:text; background-clip:text; color: transparent;
      text-shadow: 0 6px 30px rgba(0,0,0,.25);
      animation: shine 5s linear infinite;
    }
    @keyframes shine{
      0%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      50%{ filter: drop-shadow(0 0 12px rgba(160,220,255,.35)); }
      100%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
    }

    .subtitle{ color:var(--muted); margin:0 0 18px; font-size: clamp(14px, 1.6vw, 16px); }

    .grid{
      display:grid; grid-template-columns: repeat( auto-fit, minmax(220px, 1fr) ); gap:12px; position:relative; z-index:1;
    }
    .feat{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; padding:14px; display:flex; gap:12px; align-items:flex-start;
    }
    .feat i{ font-style:normal; font-size:20px; }
    .feat h3{ margin:0 0 6px; font-size:16px }
    .feat p{ margin:0; color:var(--muted); font-size:14px; }

    .cta{
      margin-top:18px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; position:relative; z-index:1;
    }
    .btn{
      appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#091317;
      box-shadow: 0 8px 22px rgba(0,150,200,.25);
    }
    .btn.secondary{ background: transparent; color:#e9e6ff; border:1px solid rgba(255,255,255,0.18); box-shadow:none }
    .mutelink{ color:#b9b6c9; text-decoration:underline dotted; text-underline-offset:3px; }

    footer{ margin-top:18px; color:#a7a2ba; font-size:12px; position:relative; z-index:1; }

    /* Modal Gate */
    .gate{
      position:fixed; inset:0; display:grid; place-items:center; background: rgba(7,10,20,0.75);
      backdrop-filter: blur(8px); padding:18px; z-index:100;
    }
    .gate-card{
      width:min(920px, 100%);
      background: rgba(17,10,31,0.9);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:16px; box-shadow: var(--shadow);
      padding: clamp(16px, 2.2vw, 22px);
      max-height: 86vh; overflow:auto;
    }
    .gate h2{ margin:0 0 10px; font-size: clamp(18px, 2.4vw, 24px); }
    .gate h3{ margin:18px 0 8px; font-size: 16px; }
    .list{ margin:0; padding-left:20px; color:#d8d4e6; }
    .list li{ margin:6px 0; }

    .checks{ display:grid; gap:10px; margin-top:14px; }
    .confirm{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between; margin-top:12px;
    }
    .confirm .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .accept{ opacity:.5; pointer-events:none; }
    .reset-link{ font-size:12px; }

    /* Mobile title swap */
    @media (max-width: 420px){
      .title .full{ display:none }
      .title .short{ display:block }
    }

    /* --- Langeweile-Spiel styles --- */
    .game-wrap{
      margin-top:20px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; padding:14px;
    }
    .game-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .game-info{ color:var(--muted); font-size:14px; }
    .scoreboard{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .score{ font-weight:800; }
    .phase{ font-size:12px; opacity:.85; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.15); }
    canvas{ width:100%; height:auto; display:block; background:#0b1b2a; border-radius:10px; border:1px solid rgba(255,255,255,0.08); }
    .controls{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .jump-btn{ padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); color:#fff; font-weight:700; }
    .top5{ margin-top:12px; }
    .top5 h4{ margin:0 0 8px; }
    .top5 ul{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
    .top5 li{ display:flex; justify-content:space-between; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:8px 10px; }
  </style>
</head>
<body>
  <noscript>
    <div style="padding:16px; background:#ffecb3; color:#402; text-align:center; font-weight:600;">Bitte aktiviere JavaScript, um diese Seite zu nutzen.</div>
  </noscript>

  <!-- Consent Gate (hidden after accept) -->
  <div class="gate" id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <h2>Regeln & AGBs bestätigen</h2>
      <p class="subtitle">Dies ist eine Vorschau/Beta-Seite. Bitte lies die folgenden Punkte aufmerksam durch.</p>

      <h3>Spiel-Regeln (Fair Play)</h3>
      <ol class="list">
        <li>Kein Cheating: keine Hacks, keine Mods, keine Scripts, keine Bots.</li>
        <li>Keine Manipulation am Spiel/Code/Netzwerk (inkl. DevTools, Tamper-/Userscripts, Memory-/Traffic-Editoren).</li>
        <li>Keine externen Geräte/Automationen (Makros, Auto-Clicker, Macro-Controller, etc.).</li>
        <li>Kein Reverse Engineering, Kopieren, Re-Hosting oder Weitergabe der Datei.</li>
        <li>Kein Ausnutzen von Bugs/Glitches. Bitte melde Fehler stattdessen.</li>
        <li>Respektvoller Umgang. Verstöße können zum Ausschluss führen.</li>
      </ol>

      <h3>AGB (Kurzfassung – unverbindliches Beispiel)</h3>
      <ul class="list">
        <li><b>Beta/Preview:</b> Die Anwendung befindet sich in Entwicklung; Funktionen können sich ändern oder ausfallen.</li>
        <li><b>Sicherheit:</b> Nutze <u>kein</u> Passwort, das du irgendwo sonst verwendest. Verwende einen Fantasienamen.</li>
        <li><b>Speicherung:</b> Technisch notwendige Daten (z. B. Einwilligung) können lokal (LocalStorage) gespeichert werden.</li>
        <li><b>Werbung:</b> Derzeit keine Werbung; zukünftige Einbindung ist möglich.</li>
        <li><b>Kein Rebranding:</b> Die Datei darf nicht als eigene ausgegeben, verkauft oder weiterverbreitet werden.</li>
        <li><b>Haftung:</b> Keine Gewähr für Verfügbarkeit, Richtigkeit, Datenverlust oder Schäden.</li>
        <li><b>Änderungen:</b> Regeln/AGB können aktualisiert werden. Prüfe sie bei Änderungen erneut.</li>
      </ul>

      <div class="checks">
        <label><input type="checkbox" id="cRules"> Ich habe die <b>Regeln</b> gelesen und akzeptiere sie.</label>
        <label><input type="checkbox" id="cTerms"> Ich habe die <b>AGBs</b> gelesen und akzeptiere sie.</label>
      </div>

      <div class="confirm">
        <div class="left">
          <button class="btn accept" id="acceptBtn">Bestätigen & fortfahren</button>
          <button class="btn secondary" id="declineBtn" aria-label="Ablehnen">Ablehnen</button>
        </div>
        <a class="mutelink reset-link" href="#" id="explainReset">Zustimmung später zurücksetzen</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <main class="card" aria-live="polite">
      <header>
        <div class="brand">
          <div class="logo">🎮</div>
          <div class="title">
            <div class="full">Emoji Match 3</div>
            <div class="short">E.M.3</div>
          </div>
          <span class="badge" title="Info">Großes Update in Arbeit</span>
        </div>
        <a class="mutelink" href="#" id="resetConsent">AGB & Regeln zurücksetzen</a>
      </header>

      <section class="hero">
        <h1 class="coming" aria-label="Coming Soon">Coming&nbsp;Soon</h1>
        <p class="subtitle">Vorschau von JK Games. Bleib dran – das nächste große Update landet bald.</p>
      </section>

      <section class="grid" aria-label="Highlights">
        <article class="feat">
          <i>👤</i>
          <div>
            <h3>Konto-System</h3>
            <p>Erstelle ein Konto (Fantasiename empfohlen) und verwalte dein Profil.</p>
          </div>
        </article>
        <article class="feat">
          <i>💰</i>
          <div>
            <h3>Geld verdienen</h3>
            <p>Spiele, meistere Challenges und sammle In‑Game‑Währung.</p>
          </div>
        </article>
        <article class="feat">
          <i>🏆</i>
          <div>
            <h3>Bestenliste</h3>
            <p>Vergleiche deine Bestleistung live mit anderen.</p>
          </div>
        </article>
        <article class="feat">
          <i>🎨</i>
          <div>
            <h3>Volle Design‑Kontrolle</h3>
            <p>Passe Farben, Hintergründe und Effekte komplett nach deinem Style an.</p>
          </div>
        </article>
        <article class="feat">
          <i>⚙️</i>
          <div>
            <h3>Viele Möglichkeiten</h3>
            <p>Power‑Ups, Spielmodi, Daily‑Ziele und mehr – alles im Aufbau.</p>
          </div>
        </article>
        <article class="feat">
          <i>🔒</i>
          <div>
            <h3>Hinweis zur Sicherheit</h3>
            <p>Nutze ein einzigartiges Passwort nur für dieses Spiel (keine sensiblen Daten).</p>
          </div>
        </article>
      </section>

      <!-- Langeweile-Spiel section -->
      <section class="game-wrap" aria-label="Langeweile-Spiel">
        <div class="game-header">
          <div class="game-info">
            <strong>Langeweile‑Spiel</strong> • Springen: <kbd>Leertaste</kbd>/<kbd>▲</kbd> • Mobile: Button
          </div>
          <div class="scoreboard">
            <span class="phase" id="phaseTag">Oberwelt</span>
            <span class="score">Score: <span id="score">0</span></span>
            <button class="btn" id="startBtn" type="button">Starten</button>
            <button class="btn secondary" id="restartBtn" type="button" style="display:none">Nochmal</button>
          </div>
        </div>
        <canvas id="game" width="800" height="220" aria-label="Runner Spiel"></canvas>
        <div class="controls">
          <button class="jump-btn" id="jumpBtn" type="button">Springen</button>
        </div>

        <div class="top5">
          <h4>Top&nbsp;5 (Live)</h4>
          <ul id="top5List">
            <li><em>Noch keine Einträge…</em><span></span></li>
          </ul>
        </div>
      </section>

      <footer>
        <p>© <span id="year"></span> JK Games • Vorschau-Build • Dies ist keine rechtsverbindliche Beratung. Inhalte können sich ändern.</p>
      </footer>
    </main>
  </div>

  <!-- Consent / UI script (non-module) -->
  <script>
    (function(){
      const KEY = 'em3_consent_v1';
      const gate = document.getElementById('gate');
      const acceptBtn = document.getElementById('acceptBtn');
      const declineBtn = document.getElementById('declineBtn');
      const cRules = document.getElementById('cRules');
      const cTerms = document.getElementById('cTerms');
      const resetConsent = document.getElementById('resetConsent');
      const explainReset = document.getElementById('explainReset');
      const year = document.getElementById('year');
      year.textContent = new Date().getFullYear();

      function checkAccepted(){
        const ok = cRules.checked && cTerms.checked;
        acceptBtn.classList.toggle('accept', !ok);
        acceptBtn.setAttribute('aria-disabled', (!ok).toString());
      }

      cRules.addEventListener('change', checkAccepted);
      cTerms.addEventListener('change', checkAccepted);
      checkAccepted();

      // Show/Hide gate based on stored consent
      const has = localStorage.getItem(KEY) === '1';
      if(has){ gate.style.display = 'none'; }

      acceptBtn.addEventListener('click', () => {
        if(acceptBtn.classList.contains('accept')) return;
        localStorage.setItem(KEY, '1');
        gate.style.display = 'none';
      });

      declineBtn.addEventListener('click', () => {
        alert('Ohne Zustimmung ist die Nutzung leider nicht möglich.');
        history.length > 1 ? history.back() : window.location.href = 'about:blank';
      });

      resetConsent.addEventListener('click', (e) => {
        e.preventDefault();
        if(confirm('Zustimmung zurücksetzen? Beim nächsten Besuch werden Regeln & AGBs erneut abgefragt.')){
          localStorage.removeItem(KEY);
          alert('Zustimmung wurde zurückgesetzt.');
        }
      });

      explainReset.addEventListener('click', (e) => {
        e.preventDefault();
        alert('Hinweis: Deine Zustimmung wird lokal im Browser gespeichert (LocalStorage). Über den Link oben rechts kannst du sie jederzeit zurücksetzen.');
      });
    })();
  </script>

  <!-- Game + Firebase (module) -->
  <script type="module">
    // --- Firebase Setup (v10 modular) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBa-8wKtWpiFVFeUrNJedjYsuIQLbI0JLQ",
      authDomain: "j-k--games.firebaseapp.com",
      projectId: "j-k--games",
      storageBucket: "j-k--games.firebasestorage.app",
      messagingSenderId: "779886305498",
      appId: "1:779886305498:web:d8e0f24b214805904285e3",
      measurementId: "G-YE25QXV7PV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM refs ---
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const jumpBtn = document.getElementById('jumpBtn');
    const scoreEl = document.getElementById('score');
    const phaseTag = document.getElementById('phaseTag');
    const top5List = document.getElementById('top5List');

    // --- Game state ---
    let running = false;
    let gameOver = false;
    let t0 = 0;
    let last = 0;
    let score = 0;
    let speed = 210; // px/sec
    let gravity = 1250; // px/sec^2
    let groundY = canvas.height - 40;

    const player = {
      x: 60,
      y: groundY - 40,
      w: 28,
      h: 40,
      vy: 0,
      onGround: true
    };

    const obstacles = [];
    let spawnTimer = 0;

    function rand(min, max){ return Math.random() * (max - min) + min; }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function resetGame(){
      running = false; gameOver = false;
      score = 0; speed = 210;
      player.y = groundY - player.h; player.vy = 0; player.onGround = true;
      obstacles.length = 0; spawnTimer = 0;
      t0 = performance.now(); last = t0;
      scoreEl.textContent = '0';
      phaseTag.textContent = 'Oberwelt';
      startBtn.style.display = 'inline-block';
      restartBtn.style.display = 'none';
      draw(0); // initial frame
    }

    function startGame(){
      if(running) return;
      running = true; gameOver = false;
      t0 = performance.now(); last = t0;
      requestAnimationFrame(loop);
    }

    function endGame(){
      running = false; gameOver = true;
      restartBtn.style.display = 'inline-block';
      startBtn.style.display = 'none';
      // submit score
      submitScore(Math.floor(score)).catch(console.warn);
    }

    function jump(){
      if(!running || gameOver) return;
      if(player.onGround){
        player.vy = -520; // jump impulse
        player.onGround = false;
      }
    }

    function currentPhase(elapsed){
      // 0..60s Oberwelt; 61..71s Übergang; >71s Hölle
      if(elapsed <= 60) return { name: 'Oberwelt', mix: 0 };
      const mix = clamp((elapsed - 61) / 10, 0, 1);
      return { name: mix >= 1 ? 'Hölle' : 'Übergang', mix };
    }

    function drawBackground(elapsed){
      const { mix } = currentPhase(elapsed);
      // Interpolate colors from overworld to nether
      const sky1 = { r: 11, g: 27, b: 42 };   // #0b1b2a
      const sky2 = { r: 58, g: 10, b: 10 };   // dark red
      const grd = ctx.createLinearGradient(0,0,0,canvas.height);
      function lerp(a,b,t){ return Math.round(a + (b - a)*t); }
      const cTop = `rgb(${lerp(20, 20, mix)}, ${lerp(40, 8, mix)}, ${lerp(60, 8, mix)})`;
      const cMid = `rgb(${lerp(11, 58, mix)}, ${lerp(27, 10, mix)}, ${lerp(42, 10, mix)})`;
      grd.addColorStop(0, cTop);
      grd.addColorStop(1, cMid);
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // ground
      const groundColor = mix < 1 ? `rgb(${lerp(22,40,mix)}, ${lerp(90,20,mix)}, ${lerp(30,20,mix)})`
                                  : `rgb(60,20,20)`;
      ctx.fillStyle = groundColor;
      ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);

      // horizon glow/lava fog
      ctx.fillStyle = `rgba(${lerp(200,255,mix)}, ${lerp(200,60,mix)}, ${lerp(220,40,mix)}, ${0.06 + 0.12*mix})`;
      ctx.fillRect(0, groundY-30, canvas.width, 30);
    }

    function drawPlayer(){
      // Simple blocky avatar \"Steve\"-like (keine offiziellen Assets)
      // Head
      ctx.fillStyle = '#c79c68';
      ctx.fillRect(player.x + 6, player.y, 16, 16);
      // Body
      ctx.fillStyle = '#2aa3d8'; // shirt
      ctx.fillRect(player.x + 4, player.y + 16, 20, 14);
      // Legs
      ctx.fillStyle = '#654ea3';
      ctx.fillRect(player.x + 6, player.y + 30, 7, 10);
      ctx.fillRect(player.x + 15, player.y + 30, 7, 10);
      // Eyes
      ctx.fillStyle = '#000';
      ctx.fillRect(player.x + 10, player.y + 5, 2, 2);
      ctx.fillRect(player.x + 18, player.y + 5, 2, 2);
    }

    function spawnObstacle(elapsed){
      const { mix } = currentPhase(elapsed);
      const type = (mix < 1) ? 'pig' : 'hog';
      const h = (type === 'pig') ? rand(18, 22) : rand(26, 32);
      const w = (type === 'pig') ? rand(28, 36) : rand(34, 44);
      obstacles.push({
        x: canvas.width + 10,
        y: groundY - h,
        w, h,
        type
      });
    }

    function drawObstacle(o){
      if(o.type === 'pig'){
        ctx.fillStyle = '#ffb8c2'; // pink
        ctx.fillRect(o.x, o.y, o.w, o.h);
        // snout
        ctx.fillStyle = '#ff8fa3';
        ctx.fillRect(o.x + o.w*0.6, o.y + o.h*0.4, o.w*0.28, o.h*0.28);
      } else {
        // hoglin-like block
        ctx.fillStyle = '#9b6a4a'; // brown
        ctx.fillRect(o.x, o.y, o.w, o.h);
        // tusks
        ctx.fillStyle = '#e5d7c8';
        ctx.fillRect(o.x + 2, o.y + o.h*0.2, 4, 4);
        ctx.fillRect(o.x + 2, o.y + o.h*0.55, 4, 4);
      }
    }

    function loop(now){
      if(!running) return;
      const dt = (now - last) / 1000;
      last = now;
      const elapsed = (now - t0) / 1000;

      // Update phase tag
      const phase = currentPhase(elapsed);
      phaseTag.textContent = (phase.mix < 1) ? 'Oberwelt' : 'Hölle';

      // speed increases over time
      speed += dt * 3.5;
      score += dt * 10;
      scoreEl.textContent = String(Math.floor(score));

      // physics
      player.vy += gravity * dt;
      player.y += player.vy * dt;
      if(player.y + player.h >= groundY){
        player.y = groundY - player.h;
        player.vy = 0;
        player.onGround = true;
      }

      // spawn
      spawnTimer -= dt;
      if(spawnTimer <= 0){
        spawnObstacle(elapsed);
        spawnTimer = (phase.mix < 1) ? rand(0.9, 1.6) : rand(0.75, 1.3);
      }

      // move obstacles
      for(let i=obstacles.length-1;i>=0;i--){
        const o = obstacles[i];
        o.x -= speed * dt;
        if(o.x + o.w < 0) obstacles.splice(i,1);
      }

      // collisions
      for(const o of obstacles){
        if(player.x < o.x + o.w && player.x + player.w > o.x && player.y < o.y + o.h && player.y + player.h > o.y){
          endGame();
        }
      }

      // draw
      drawBackground(elapsed);

      // ground details
      ctx.strokeStyle = 'rgba(255,255,255,0.07)';
      ctx.beginPath();
      ctx.moveTo(0, groundY + 0.5);
      ctx.lineTo(canvas.width, groundY + 0.5);
      ctx.stroke();

      // player & obstacles
      drawPlayer();
      obstacles.forEach(drawObstacle);

      if(running) requestAnimationFrame(loop);
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground(0);
      drawPlayer();
    }

    // --- Scoreboard (Firestore Top 5) ---
    function sanitizeName(name){
      name = (name || '').trim();
      if(!name) name = 'Gast';
      return name.replace(/[<>]/g, '');
    }

    async function submitScore(score){
      try{
        const nameKey = 'em3_player_name';
        let name = localStorage.getItem(nameKey) || prompt('Name für die Bestenliste (Tipp: Fantasiename)?');
        name = sanitizeName(name);
        localStorage.setItem(nameKey, name);
        await addDoc(collection(db, 'em3_scores'), { name, score, ts: serverTimestamp() });
      } catch(err){
        console.warn('Konnte Score nicht speichern:', err?.message || err);
        // Nicht blockieren – nur Info für den Spieler
        alert('Score gespeichert (lokal). Online-Bestenliste evtl. nicht verfügbar.');
      }
    }

    // Live Top 5
    (function initTop5(){
      const q = query(collection(db, 'em3_scores'), orderBy('score', 'desc'), limit(5));
      onSnapshot(q, (snap) => {
        const items = [];
        let rank = 1;
        snap.forEach(doc => {
          const d = doc.data();
          items.push({ rank: rank++, name: (d.name||'–'), score: d.score||0 });
        });
        if(items.length === 0){
          top5List.innerHTML = '<li><em>Noch keine Einträge…</em><span></span></li>';
          return;
        }
        top5List.innerHTML = items.map(it => `<li><span>#${it.rank} ${String(it.name).replace(/[<>]/g,'')}</span><span>${it.score}</span></li>`).join('');
      }, (err) => {
        console.warn('Top5 Snapshot Fehler:', err?.message || err);
      });
    })();

    // --- Events ---
    startBtn.addEventListener('click', () => { resetGame(); startGame(); });
    restartBtn.addEventListener('click', () => { resetGame(); startGame(); });
    jumpBtn.addEventListener('click', jump);
    window.addEventListener('keydown', (e) => {
      if(e.code === 'Space' || e.code === 'ArrowUp'){ e.preventDefault(); jump(); }
    });

    // Resize handling (keep aspect)
    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const scale = rect.width / canvas.width;
      // Adjust ground based on current height scaling
      groundY = canvas.height - 40;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // initial render
    draw();
  </script>
</body>
</html>
